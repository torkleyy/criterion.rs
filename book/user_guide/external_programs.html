<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Benchmarking External Programs - Criterion.rs Documentation</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="User Guide and Other Prose Documentation For Criterion.rs">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch store.js from local - TODO add CDN when 2.x.x is available on cdnjs -->
        <script src="store.js"></script>

    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = store.get('mdbook-theme');
            if (theme === null || theme === undefined) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = store.get('mdbook-sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li><a href="./criterion_rs.html"><strong>1.</strong> Criterion.rs</a></li><li><ul class="section"><li><a href="./getting_started.html"><strong>1.1.</strong> Getting Started</a></li></ul></li><li><a href="./user_guide/user_guide.html"><strong>2.</strong> User Guide</a></li><li><ul class="section"><li><a href="./user_guide/command_line.html"><strong>2.1.</strong> Command-Line Output</a></li><li><a href="./user_guide/plots_and_graphs.html"><strong>2.2.</strong> Plots &amp; Graphs</a></li><li><a href="./user_guide/benchmarking_with_inputs.html"><strong>2.3.</strong> Benchmarking With Inputs</a></li><li><a href="./user_guide/comparing_functions.html"><strong>2.4.</strong> Comparing Functions</a></li><li><a href="./user_guide/external_programs.html" class="active"><strong>2.5.</strong> Benchmarking External Programs</a></li></ul></li><li><a href="./analysis.html"><strong>3.</strong> Analysis Process</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page" tabindex="-1">
                
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars" title="Toggle sidebar"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush" title="Change theme"></i>
                    </div>

                    <h1 class="menu-title">Criterion.rs Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html">
                            <i id="print-button" class="fa fa-print" title="Print this book"></i>
                        </a>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="./user_guide/external_programs.html#benchmarking-external-programs" id="benchmarking-external-programs"><h1>Benchmarking External Programs</h1></a>
<p>Criterion.rs has the ability to benchmark external programs (which may be written in any language) the same way that it can benchmark rust functions. What follows is an example of how that can be done and some of the pitfalls to avoid along the way.</p>
<p>First, let's define our recursive Fibonacci function, only in Python this time:</p>
<pre><code class="language-python">def fibonacci(n):
    if n == 0 or n == 1:
        return 1
    return fibonacci(n-1) + fibonacci(n-2)
</code></pre>
<p>In order to benchmark this with Criterion.rs, we first need to write our own small benchmarking harness. I'll start with the complete code for this and then go over it in more detail:</p>
<pre><code class="language-python">import time
import sys

MILLIS = 1000
MICROS = MILLIS * 1000
NANOS = MICROS * 1000

def benchmark():
    argument = int(sys.argv[1])

    for line in sys.stdin:
        iters = int(line.strip())

        # Setup

        start = time.perf_counter()
        for x in range(iters):
            fibonacci(argument)
        end = time.perf_counter()

        # Teardown

        delta = end - start
        nanos = int(delta * NANOS)
        print(&quot;%d&quot; % nanos)
        sys.stdout.flush()

benchmark()
</code></pre>
<p>The important part is the <code>benchmark()</code> function.</p>
<a class="header" href="./user_guide/external_programs.html#the-argument" id="the-argument"><h3>The Argument</h3></a>
<pre><code class="language-python">argument = int(sys.argv[1])
</code></pre>
<p>This example uses the <code>Criterion::bench_program_over_inputs</code> function to benchmark our Python Fibonacci function with a variety of inputs. The external program recieves the input value as a command-line argument appended to the command specified in the benchmark, so the very first thing our benchmark harness does is parse that argument into an integer. If we used <code>bench_program</code> instead, there would be no argument.</p>
<a class="header" href="./user_guide/external_programs.html#reading-from-stdin" id="reading-from-stdin"><h3>Reading from stdin</h3></a>
<pre><code class="language-python">    for line in sys.stdin:
        iters = int(line.strip())
</code></pre>
<p>Next, our harness reads a line from stdin and parses it into an integer. Starting an external process is slow, and it would mess with our measurements if we had to do so for each iteration of the benchmark. Besides which, it would obscure the results (since we're probably more interested in the performance of the function without the process-creation overhead). Therefore, Criterion.rs starts the process once per input value or benchmark and sends the iteration counts to the external program on stdin. Your external benchmark harness must read and parse this iteration count and call the benchmarked function the appropriate number of times.</p>
<a class="header" href="./user_guide/external_programs.html#setup" id="setup"><h3>Setup</h3></a>
<p>If your benchmarked code requires any setup, this is the time to do that.</p>
<a class="header" href="./user_guide/external_programs.html#timing" id="timing"><h3>Timing</h3></a>
<pre><code class="language-python">        start = time.perf_counter()
        for x in range(iters):
            fibonacci(argument)
        end = time.perf_counter()
</code></pre>
<p>This is the heart of the external benchmark harness. We measure how long it takes to execute our Fibonacci function with the given argument in a loop, iterating the given number of times. It's important here to use the most precise timer available. We'll need to report the measurement in nanoseconds later, so if you can use a timer that returns a value in nanoseconds (eg. Java's <code>System.nanoTime()</code>) we can skip a bit of work later. It's OK if the timer can't measure to nanosecond precision (most PC's can't) but use the best timer you have.</p>
<a class="header" href="./user_guide/external_programs.html#teardown" id="teardown"><h3>Teardown</h3></a>
<p>If your benchmarked code requires any teardown, this is the time to do that.</p>
<a class="header" href="./user_guide/external_programs.html#reporting" id="reporting"><h3>Reporting</h3></a>
<pre><code class="language-python">        delta = end - start
        nanos = int(delta * NANOS)
        print(&quot;%d&quot; % nanos)
        sys.stdout.flush()
</code></pre>
<p>To report the measured time, simply print the elapsed number of nanoseconds to stdout. <code>perf_counter</code> reports its results as a floating-point number of seconds, so we first convert it to an integer number of nanoseconds before printing it.</p>
<p><strong>Beware Buffering:</strong> Criterion.rs will wait until it recieves the measurement before sending the next iteration count. If your benchmarks seem to be hanging during the warmup period, it may be because your benchmark harness is buffering the output on stdout, as Python does here. In this example we explicitly force Python to flush the buffer; you may need to do the same in your benchmarks.</p>
<a class="header" href="./user_guide/external_programs.html#defining-the-benchmark" id="defining-the-benchmark"><h2>Defining the Benchmark</h2></a>
<p>If you've read the earlier pages, this will be quite familiar.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
use criterion::Criterion;
use std::process::Command;

fn create_command() -&gt; Command {
    let mut command = Command::new(&quot;python3&quot;);
    command.arg(&quot;benches/external_process.py&quot;);
    command
}

fn python_fibonacci(c: &amp;mut Criterion) {
    c.bench_program_over_inputs(&quot;fibonacci-python&quot;,
        create_command,
        &amp;[1, 2, 4, 8, 16]);
}
#}</code></pre></pre>
<p>As before, we create a <code>Criterion</code> struct and use it to define our benchmark. This time, we use the <code>bench_program_over_inputs</code> method. This takes a function (used to create the <code>Command</code> which represents our external program) and an iterable containing the inputs to test. Aside from the use of a <code>Command</code> rather than a closure, this behaves just like (and produces the same output as) <code>bench_function_over_inputs</code>.</p>
<p>If your benchmark doesn't require input, simply omit the input values and use <code>bench_program</code> instead, which behaves like <code>bench_function</code>.</p>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a rel="prev" href="./user_guide/comparing_functions.html" class="mobile-nav-chapters previous" title="Previous chapter">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="./analysis.html" class="mobile-nav-chapters next" title="Next chapter">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="./user_guide/comparing_functions.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="./analysis.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
